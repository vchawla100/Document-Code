CREATE PROCEDURE [dbo].[RAK_TWC_PendingWithOPS]
(
    @BatchingReq NVARCHAR(5),
    @BatchSize NVARCHAR(20),
    @OrderBy INT, 
    @SortField NVARCHAR(64), 
    @SortFieldValue NVARCHAR(64), 
    @SortOrder NVARCHAR(5), 
    @KeyField NVARCHAR(64),
    @ExpiryDate DATETIME
)
AS 
BEGIN
    DECLARE @QueryString NVARCHAR(MAX)
    DECLARE @WhereClause NVARCHAR(1000)
    DECLARE @ErrorMessage NVARCHAR(4000)

    BEGIN TRY
        -- Initialize query string and where clause
        SET @QueryString = ''
        SET @WhereClause = ''

        -- Log the initial state
        PRINT 'Starting Procedure Execution'
        PRINT 'BatchingReq: ' + @BatchingReq
        PRINT 'BatchSize: ' + @BatchSize
        PRINT 'OrderBy: ' + CAST(@OrderBy AS NVARCHAR)
        PRINT 'SortField: ' + @SortField
        PRINT 'SortFieldValue: ' + @SortFieldValue
        PRINT 'SortOrder: ' + @SortOrder
        PRINT 'KeyField: ' + @KeyField
        PRINT 'ExpiryDate: ' + CAST(@ExpiryDate AS NVARCHAR)

        -- Build the main query
        SET @QueryString = '
            SELECT 
                A.Customer_Name,
                A.WI_NAME AS [WorkItem Number],
                A.CIF_Id AS [CIF Number],
                A.First_Level_Business_Approver AS [First Level Business Approver],
                A.Second_Level_Business_Approver AS [Second Level Business Approver],
                A.Product_Identifier AS [Product],
                A.Request_Type AS [Request Type],
                A.Islamic_Or_Conventional AS [Islamic/Conventional],
                A.Limit_Type AS [Limit Type],
                A.Reference_Number AS [LAF number],
                A.Current_WS AS [Queue Name],
                B.entrydatetime AS [SalesDeferralMaker Entrydatetime],
                C.DOCUMENT_TYPE AS [Deferral Document Type],
                C.APPROVING_AUTH_NAME AS [Deferral Approving Authority],
                C.DEFERRAL_EXPIRY_DATE AS [Deferral Expiry Date],
                C.REMARKS AS [Deferral Remarks],
                C.DEFERRAL_STATUS AS [Deferral Status]
            FROM 
                RB_TWC_EXTTABLE A
            JOIN 
                USR_0_TWC_DEFERRAL_DTLS_GRID B
            ON 
                A.WI_NAME = B.WI_NAME
            LEFT JOIN 
                USR_O_TWC_WIHISTORY C
            ON 
                A.WI_NAME = C.WI_NAME
            WHERE 
                B.DEFERRAL_STATUS IN (''Deferred'', ''Open'')
                AND A.Prev_WS IN (''CROPS_Deferral_Checker'', ''Sales_Deferral_Maker'')
                AND DATEDIFF(day, GETDATE(), TRY_CAST(C.DEFERRAL_EXPIRY_DATE AS datetime)) > 0
                AND TRY_CAST(C.DEFERRAL_EXPIRY_DATE AS datetime) = @ExpiryDate
        '

        -- Log the main query before any modifications
        PRINT 'Main Query: ' + @QueryString

        -- Apply ordering if specified
        IF @OrderBy = 1 AND @SortField IS NOT NULL AND @SortOrder IS NOT NULL
        BEGIN
            SET @QueryString = @QueryString + ' ORDER BY ' + QUOTENAME(@SortField) + ' ' + @SortOrder
            PRINT 'OrderBy Applied: ' + @QueryString
        END

        -- Apply batching if required
        IF @BatchingReq = 'Y'
        BEGIN
            SET @QueryString = 'WITH CTE AS (' + @QueryString + ')
                                SELECT TOP ' + @BatchSize + ' * FROM CTE'
            PRINT 'Batching Applied: ' + @QueryString
        END

        -- Log the final query before execution
        PRINT 'Final Query: ' + @QueryString

        -- Execute the dynamic query
        EXEC sp_executesql @QueryString, N'@ExpiryDate DATETIME', @ExpiryDate
        PRINT 'Query Executed Successfully'

    END TRY
    BEGIN CATCH
        -- Capture the error message
        SELECT @ErrorMessage = ERROR_MESSAGE()
        PRINT 'Error Occurred: ' + @ErrorMessage
    END CATCH
END
